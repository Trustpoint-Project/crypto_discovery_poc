from django.shortcuts import render, redirect
from django.contrib import messages
from .models import DiscoveredDevice
from .scanner import OTScanner

# Global flag
SCAN_RUNNING = False

def run_scan_in_background(cidr):
    """Run scan in background thread."""
    global SCAN_RUNNING
    SCAN_RUNNING = True
    
    print(f"--- Background Scan Started on {cidr} ---")
    try:
        scanner = OTScanner()
        results = scanner.scan_network(cidr)
        
        # Save results to DB
        for device_data in results:
            DiscoveredDevice.objects.update_or_create(
                ip_address=device_data['ip'],
                defaults={
                    'hostname': device_data['hostname'],
                    'open_ports': device_data['ports'],
                    'ssl_info': device_data['ssl_info']
                }
            )
    except Exception as e:
        print(f"Error during scan: {e}")
    finally:
        print("--- Background Scan Finished ---")
        SCAN_RUNNING = False

def device_list(request):
    """Show the dashboard."""
    devices = DiscoveredDevice.objects.all().order_by('-last_seen')
    context = {
        'devices': devices,
        'scan_running': SCAN_RUNNING
    }
    return render(request, 'discovery/device_list.html', context)

def start_scan(request):
    """Trigger the scan based on user input."""
    global SCAN_RUNNING
    if request.method == 'POST':
        # Get the CIDR from the input box
        target_cidr = request.POST.get('cidr')
        
        if not target_cidr:
            messages.error(request, "Please enter a valid CIDR range.")
            return redirect('device_list')

        if not SCAN_RUNNING:
            # Pass the user input to the thread
            thread = threading.Thread(target=run_scan_in_background, args=(target_cidr,))
            thread.daemon = True
            thread.start()
            
            messages.success(request, f"Scan started on {target_cidr}. Please wait...")
        else:
            messages.warning(request, "A scan is already in progress.")
            
    return redirect('device_list')
